name: Tests

on:
  pull_request:

  push:
    branches:
      - main
      - 'feature/**'
      - 'support/**'

  workflow_dispatch:

permissions:
  pull-requests: write

concurrency:
  group: tests-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  install:
    name: Install
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        uses: ./.github/workflows/actions/install-node

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [install]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build
        uses: ./.github/workflows/actions/build

  lint:
    name: ${{ matrix.description }}
    runs-on: ubuntu-latest
    needs: [install]

    strategy:
      fail-fast: false

      matrix:
        include:
          - description: Lint Sass
            name: lint-scss
            run: npm run lint:scss
            cache: .cache/stylelint

          - description: Lint JavaScript
            name: lint-js
            run: npm run lint:js
            cache: .cache/eslint

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Restore dependencies
        uses: ./.github/workflows/actions/install-node

      - name: Cache linter
        uses: actions/cache@v3
        with:
          key: ${{ matrix.name }}-cache
          path: ${{ matrix.cache }}

      - name: Run lint task
        run: ${{ matrix.run }}

  test:
    name: ${{ matrix.description }}
    runs-on: ubuntu-latest
    needs: [install]

    strategy:
      fail-fast: false

      matrix:
        include:
          - description: Nunjucks macro tests
            name: test-macro
            run: npx jest --color --selectProjects "Nunjucks macro tests"

          - description: JavaScript unit tests
            name: test-unit
            run: npx jest --color --maxWorkers=2 --selectProjects "JavaScript unit tests" --coverage --testLocationInResults

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Restore dependencies
        uses: ./.github/workflows/actions/install-node

      - name: Cache Jest
        uses: actions/cache@v3
        with:
          key: ${{ matrix.name }}-cache
          path: .cache/jest

      - name: Run test task
        run: ${{ matrix.run }}

      - name: Save test coverage
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.description }} coverage
          path: coverage
          if-no-files-found: ignore

  verify:
    name: ${{ matrix.description }}
    runs-on: ubuntu-latest
    needs: [install, build]

    strategy:
      fail-fast: false

      matrix:
        include:
          - description: JavaScript behaviour tests
            name: test-behaviour
            run: npx jest --color --maxWorkers=2 --selectProjects "JavaScript behaviour tests"

          - description: JavaScript component tests
            name: test-component
            run: npx jest --color --maxWorkers=2 --selectProjects "JavaScript component tests"

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Restore dependencies
        uses: ./.github/workflows/actions/install-node

      - name: Restore build
        uses: ./.github/workflows/actions/build

      - name: Cache Jest
        uses: actions/cache@v3
        with:
          key: ${{ matrix.name }}-cache
          path: .cache/jest

      - name: Run verify task
        run: ${{ matrix.run }}

  regression:
    name: Percy
    needs: [install, build]

    # Run existing "Percy screenshots" workflow
    # (after install and build have been cached)
    uses: ./.github/workflows/screenshots.yml
    secrets: inherit

    # Skip when secrets are unavailable on forks
    if: ${{ github.repository_owner == 'alphagov' }}

  build_dist:
    name: Build dist
    needs: [install]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Restore dependencies
        uses: ./.github/workflows/actions/install-node

      - name: Build dist
        uses: ./.github/workflows/actions/build-dist

  build_package:
    name: Build package
    needs: [install]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Restore dependencies
        uses: ./.github/workflows/actions/install-node

      - name: Build package
        uses: ./.github/workflows/actions/build-package

  stats:
    name: Stats
    needs: [build_dist,build_package]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Restore dependencies
        uses: ./.github/workflows/actions/install-node

      - name: Restore dist
        uses: ./.github/workflows/actions/build-dist

      - name: Restore package
        uses: ./.github/workflows/actions/build-package

      - name: Collects stats
        run: npm start --workspace stats

      - name: Save stats
        uses: actions/upload-artifact@v3
        with:
          name: File stats
          path: stats/public/all/stats-sunburst.html
          if-no-files-found: ignore

      - name: Add comment to PR
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const commentOnPr = require('./stats/comment-on-pr.js');
            await commentOnPr({github,context})

        if: github.event_name == 'pull_request'


